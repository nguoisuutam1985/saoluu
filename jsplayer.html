<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Video.js Popup + Playlist + Seek + Click Outside Close</title>
<link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet">
<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<style>
body { font-family: Arial; margin:0; padding:0; }

#overlay {
    display: none;
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.85);
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

#video-wrapper {
    position: relative;
    width: 1000px;
    max-width: 95%;
}

#myvideo {
    width: 100%;
    height: 562px;
}

#close-overlay {
    position: absolute;
    top: 10px;
    right: 20px;
    font-size: 28px;
    color: #fff;
    cursor: pointer;
    z-index: 1001;
}

.vjs-playlist-panel {
    position: absolute;
    right: 0;
    top: 50px;
    width: 320px;
    height: 75%;
    background: rgba(20,20,20,0.95);
    color: #fff;
    overflow-y: auto;
    padding: 12px;
    border-left: 2px solid #333;
    z-index: 1000;
    display: none;
}

.vjs-playlist-item {
    padding: 10px;
    margin-bottom: 8px;
    background: #333;
    border-radius: 6px;
    cursor: pointer;
    font-size: 16px;
}
.vjs-playlist-item:hover { background: #555; }

.vjs-control-bar {
    height: 50px !important;
    font-size: 18px !important;
}

.vjs-button {
    font-size: 20px !important;
    padding: 6px 12px !important;
}
</style>
</head>
<body>

<button onclick="playMovie('dau-pha-thuong-khung-phan-5')">PLAY VIDEO</button>

<div id="overlay">
    <div id="video-wrapper">
        <div id="close-overlay">&times;</div>
        <video id="myvideo" class="video-js vjs-default-skin" controls preload="auto"></video>
    </div>
</div>

<script>
// Overlay click outside to close
const overlay = document.getElementById('overlay');

overlay.addEventListener('click', function(e){
    if(e.target === overlay){ // chỉ click ra ngoài video-wrapper
        overlay.style.display = 'none';
        if(window.player){
            window.player.pause();
            window.player.dispose();
        }
    }
});

// Close button
document.getElementById('close-overlay').addEventListener('click', () => {
    overlay.style.display = 'none';
    if(window.player){
        window.player.pause();
        window.player.dispose();
    }
});

// =========================
// Custom Control Buttons
// =========================
var Button = videojs.getComponent('Button');

// Playlist button
class PlaylistButton extends Button {
    constructor(player, options) {
        super(player, options);
        this.controlText("Playlist");
        this.el().innerHTML = "&#9776;";
        this.el().style.fontSize = "20px";
        this.el().style.padding = "0 10px";
    }
    handleClick() {
        let panel = document.querySelector('.vjs-playlist-panel');
        if (!panel) return;
        panel.style.display = (panel.style.display === 'none') ? 'block' : 'none';
    }
}

// Bài trước / bài sau
class PlaylistNavButton extends Button {
    constructor(player, options) {
        super(player, options);
        this.action = options.action;
        this.controlText(options.label);
        this.el().innerHTML = options.label;
        this.el().style.fontSize = "16px";
        this.el().style.padding = "0 8px";
    }
    handleClick() {
        if(!window.streams || window.streams.length===0) return;
        let idx = window.currentIndex || 0;
        if(this.action === 'prev') idx--;
        else if(this.action === 'next') idx++;
        if(idx < 0) idx = 0;
        if(idx >= window.streams.length) idx = window.streams.length-1;
        window.currentIndex = idx;
        window.player.src({ src: window.streams[idx].file, type: 'application/x-mpegURL' });
        window.player.play();
    }
}

// Seek ±60s
class SeekButton extends Button {
    constructor(player, options){
        super(player, options);
        this.seconds = options.seconds;
        this.controlText(options.label);
        this.el().innerHTML = options.label;
        this.el().style.fontSize = "16px";
        this.el().style.padding = "0 8px";
    }
    handleClick(){
        let t = window.player.currentTime() + this.seconds;
        if(t < 0) t = 0;
        if(t > window.player.duration()) t = window.player.duration();
        window.player.currentTime(t);
    }
}

videojs.registerComponent('PlaylistButton', PlaylistButton);
videojs.registerComponent('PlaylistNavButton', PlaylistNavButton);
videojs.registerComponent('SeekButton', SeekButton);

// =========================
// Play Movie
// =========================
async function playMovie(slug) {
    overlay.style.display = 'flex';

    window.player = videojs('myvideo');
    window.currentIndex = 0;
    window.streams = [];

    window.player.ready(async function() {
        let cb = window.player.getChild('controlBar');
        // Nút Playlist
        cb.addChild('PlaylistButton', {}, 10);
        // Nút tua ±60s
        cb.addChild('SeekButton', {seconds:-60,label:'⏪ 60s'}, 11);
        cb.addChild('SeekButton', {seconds:60,label:'60s ⏩'}, 12);
        // Nút bài trước / sau
        cb.addChild('PlaylistNavButton', {action:'prev',label:'⏮'}, 13);
        cb.addChild('PlaylistNavButton', {action:'next',label:'⏭'}, 14);

        // Panel playlist
        let panel = document.createElement('div');
        panel.className = 'vjs-playlist-panel';
        window.player.el().appendChild(panel);

        // Fetch API phimapi.com
        try {
            const url = `https://phimapi.com/phim/${slug}`;
            const res = await fetch(url);
            const data = await res.json();

            if(data.status && data.episodes && data.episodes.length>0){
                data.episodes.forEach(server=>{
                    const serverName = server.server_name;
                    server.server_data.forEach(ep=>{
                        window.streams.push({title:`${serverName} - ${ep.name}`,file:ep.link_m3u8});
                    });
                });
            }

            if(window.streams.length===0){
                panel.innerHTML="<p>Không có playlist!</p>";
                panel.style.display='block';
                return;
            }

            // Render playlist
            window.streams.forEach((item,i)=>{
                const div = document.createElement('div');
                div.className='vjs-playlist-item';
                div.innerText=item.title;
                div.onclick=()=>{
                    window.currentIndex=i;
                    window.player.src({src:item.file,type:'application/x-mpegURL'});
                    window.player.play();
                };
                panel.appendChild(div);
            });

            // Auto play tập đầu tiên
            window.player.src({ src: window.streams[0].file, type: 'application/x-mpegURL' });
            window.player.play();
            panel.style.display='block';

        } catch(err){
            console.error(err);
            alert('Không lấy được dữ liệu phim!');
        }
    });
}
</script>

</body>
</html>
